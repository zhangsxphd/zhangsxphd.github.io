<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上海市灌溉数据填报系统</title>
    
    <!-- 1. 引入 Tailwind CSS (样式库) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 定义依赖包映射 (使用 esm.sh CDN) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <!-- 3. 引入 Babel (用于在浏览器中解析 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. 引入 LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* 加载动画 */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root">
        <!-- 初始化加载界面，防止白屏 -->
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b;">
            <div class="loading-spinner"></div>
            <h2 style="font-size: 1.2rem; font-weight: bold;">系统正在加载中...</h2>
            <p style="font-size: 0.9rem; margin-top: 10px;">如果是本地直接打开 (file://)，请注意可能会因为 CORS 策略无法运行。</p>
            <p style="font-size: 0.9rem;">请上传至 GitHub Pages 或在本地服务器运行。</p>
        </div>
    </div>

    <!-- 错误捕获脚本 -->
    <script>
        window.addEventListener('error', function(e) {
            if (e.message.includes('Access-Control-Allow-Origin') || e.message.includes('module')) {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444; margin-top: 50px;">
                        <h1 style="font-size: 24px; font-weight: bold;">无法在本地直接运行</h1>
                        <p style="margin-top: 10px;">检测到跨域(CORS)错误。这是因为你可能双击了 HTML 文件直接打开。</p>
                        <div style="background: #fff; padding: 20px; border-radius: 10px; margin-top: 20px; display: inline-block; text-align: left; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <p><strong>解决方法：</strong></p>
                            <ol style="list-style: decimal; margin-left: 20px; margin-top: 10px;">
                                <li>将此文件上传到 <strong>GitHub Pages</strong> (你的 zhangsxphd.github.io)。</li>
                                <li>或者在本地安装 VS Code 插件 "Live Server" 并通过它打开。</li>
                            </ol>
                        </div>
                    </div>
                `;
            }
        });
    </script>

    <!-- 5. 应用程序逻辑 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ClipboardEdit, Save, Calendar, Droplets, Layers, Calculator, X, History,
          MapPin, Ruler, AlertCircle, AlertTriangle, Pencil, MousePointerClick,
          ChevronDown, ChevronUp, CornerDownRight, Check, Trash2, Plus, Hash,
          Loader2, Cloud, CheckSquare, Square, Wifi, WifiOff, BrainCircuit,
          Sparkles, LayoutDashboard, Sprout, Bot, BarChart3
        } from 'lucide-react';

        // LeanCloud 配置信息
        const LEANCLOUD_APP_ID = "gUdUKvrJuhv7duj8gpe5FM3w-MdYXbMMI";
        const LEANCLOUD_APP_KEY = "0XDb3n3bypxVr46iXKTRWcUV";
        const LEANCLOUD_SERVER_URL = "https://gudukvrj.api.lncldglobal.com";
        
        const apiKey = ""; 

        const STATIC_ZONES_DEF = [
          { id: 1, name: "崇明区", location: "崇明区" },
          { id: 2, name: "青浦区", location: "青浦区" },
          { id: 3, name: "松江区", location: "松江区" },
          { id: 4, name: "浦东新区", location: "浦东新区" },
          { id: 5, name: "宝山区", location: "宝山区" },
          { id: 6, name: "奉贤区", location: "奉贤区" },
          { id: 7, name: "闵行区", location: "闵行区" }
        ];

        const SEED_POINTS = [
          { zoneId: 1, name: "城桥镇样点灌区" }, { zoneId: 1, name: "堡镇样点灌区" }, { zoneId: 1, name: "新河镇样点灌区" },
          { zoneId: 1, name: "庙镇样点灌区" }, { zoneId: 1, name: "竖新镇样点灌区" }, { zoneId: 1, name: "向化镇样点灌区" },
          { zoneId: 1, name: "三星镇样点灌区" }, { zoneId: 1, name: "港沿镇样点灌区" }, { zoneId: 1, name: "中兴镇样点灌区" },
          { zoneId: 1, name: "陈家镇样点灌区" }, { zoneId: 1, name: "绿华镇样点灌区" }, { zoneId: 1, name: "港西镇样点灌区" },
          { zoneId: 1, name: "建设镇样点灌区" }, { zoneId: 1, name: "新海镇样点灌区" }, { zoneId: 1, name: "东平镇样点灌区" },
          { zoneId: 1, name: "长兴镇样点灌区" }, { zoneId: 1, name: "横沙乡样点灌区" },
          { zoneId: 2, name: "赵巷镇样点灌区" }, { zoneId: 2, name: "徐泾镇样点灌区" }, { zoneId: 2, name: "华新镇样点灌区" },
          { zoneId: 2, name: "重固镇样点灌区" }, { zoneId: 2, name: "白鹤镇样点灌区" }, { zoneId: 2, name: "朱家角镇样点灌区" },
          { zoneId: 2, name: "练塘镇样点灌区" }, { zoneId: 2, name: "金泽镇样点灌区" }, { zoneId: 2, name: "夏阳街道样点灌区" },
          { zoneId: 2, name: "盈浦街道样点灌区" }, { zoneId: 2, name: "香花桥街道样点灌区" },
          { zoneId: 3, name: "泗泾镇样点灌区" }, { zoneId: 3, name: "佘山镇样点灌区" }, { zoneId: 3, name: "车墩镇样点灌区" },
          { zoneId: 3, name: "新桥镇样点灌区" }, { zoneId: 3, name: "洞泾镇样点灌区" }, { zoneId: 3, name: "九亭镇样点灌区" },
          { zoneId: 3, name: "泖港镇样点灌区" }, { zoneId: 3, name: "石湖荡镇样点灌区" }, { zoneId: 3, name: "新浜镇样点灌区" },
          { zoneId: 3, name: "叶榭镇样点灌区" }, { zoneId: 3, name: "小昆山镇样点灌区" },
          { zoneId: 4, name: "川沙新镇样点灌区" }, { zoneId: 4, name: "祝桥镇样点灌区" }, { zoneId: 4, name: "金桥镇样点灌区" },
          { zoneId: 4, name: "曹路镇样点灌区" }, { zoneId: 4, name: "张江镇样点灌区" }, { zoneId: 4, name: "合庆镇样点灌区" },
          { zoneId: 4, name: "唐镇样点灌区" }, { zoneId: 4, name: "高桥镇样点灌区" }, { zoneId: 4, name: "高东镇样点灌区" },
          { zoneId: 4, name: "高行镇样点灌区" }, { zoneId: 4, name: "三林镇样点灌区" }, { zoneId: 4, name: "北蔡镇样点灌区" },
          { zoneId: 4, name: "康桥镇样点灌区" }, { zoneId: 4, name: "周浦镇样点灌区" }, { zoneId: 4, name: "航头镇样点灌区" },
          { zoneId: 4, name: "新场镇样点灌区" }, { zoneId: 4, name: "宣桥镇样点灌区" }, { zoneId: 4, name: "惠南镇样点灌区" },
          { zoneId: 4, name: "大团镇样点灌区" }, { zoneId: 4, name: "老港镇样点灌区" }, { zoneId: 4, name: "万祥镇样点灌区" },
          { zoneId: 4, name: "书院镇样点灌区" }, { zoneId: 4, name: "泥城镇样点灌区" },
          { zoneId: 5, name: "罗店镇样点灌区" }, { zoneId: 5, name: "大场镇样点灌区" }, { zoneId: 5, name: "杨行镇样点灌区" },
          { zoneId: 5, name: "月浦镇样点灌区" }, { zoneId: 5, name: "罗泾镇样点灌区" }, { zoneId: 5, name: "顾村镇样点灌区" },
          { zoneId: 5, name: "高境镇样点灌区" }, { zoneId: 5, name: "庙行镇样点灌区" }, { zoneId: 5, name: "淞南镇样点灌区" },
          { zoneId: 6, name: "南桥镇样点灌区" }, { zoneId: 6, name: "奉城镇样点灌区" }, { zoneId: 6, name: "庄行镇样点灌区" },
          { zoneId: 6, name: "金汇镇样点灌区" }, { zoneId: 6, name: "四团镇样点灌区" }, { zoneId: 6, name: "青村镇样点灌区" },
          { zoneId: 6, name: "柘林镇样点灌区" }, { zoneId: 6, name: "海湾镇样点灌区" },
          { zoneId: 7, name: "莘庄镇样点灌区" }, { zoneId: 7, name: "七宝镇样点灌区" }, { zoneId: 7, name: "颛桥镇样点灌区" },
          { zoneId: 7, name: "华漕镇样点灌区" }, { zoneId: 7, name: "虹桥镇样点灌区" }, { zoneId: 7, name: "梅陇镇样点灌区" },
          { zoneId: 7, name: "吴泾镇样点灌区" }, { zoneId: 7, name: "马桥镇样点灌区" }, { zoneId: 7, name: "浦江镇样点灌区" }
        ];

        function App() {
          const [zones, setZones] = useState(STATIC_ZONES_DEF.map(z => ({ ...z, points: [] }))); 
          const [records, setRecords] = useState([]);
          const [isSdkReady, setIsSdkReady] = useState(false);
          const [isLoading, setIsLoading] = useState(true);
          const [loadingMessage, setLoadingMessage] = useState("正在连接服务器...");
          
          const [selectedZone, setSelectedZone] = useState(null); 
          const [selectedPoint, setSelectedPoint] = useState(null); 
          const [expandedZoneId, setExpandedZoneId] = useState(null); 
          const [filterZoneId, setFilterZoneId] = useState(null); 
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingRecordId, setEditingRecordId] = useState(null);
          
          const [deleteModalOpen, setDeleteModalOpen] = useState(false);
          const [deleteType, setDeleteType] = useState(null);
          const [itemToDelete, setItemToDelete] = useState(null);
          const [selectedRecordIds, setSelectedRecordIds] = useState([]);
          const [editingPointId, setEditingPointId] = useState(null); 
          const [editNameValue, setEditNameValue] = useState("");     
          
          const [currentTime, setCurrentTime] = useState(new Date());
          const [isOnline, setIsOnline] = useState(navigator.onLine);

          const [aiModalOpen, setAiModalOpen] = useState(false);
          const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
          const [isGeminiAnalyzing, setIsGeminiAnalyzing] = useState(false);
          const [geminiGlobalResult, setGeminiGlobalResult] = useState(null);
          const [geminiGlobalModalOpen, setGeminiGlobalModalOpen] = useState(false);

          const [formData, setFormData] = useState({
            date: new Date().toISOString().split('T')[0],
            fieldNumber: '1',
            moistureBefore: '',
            moistureAfter: '',
            depth: '',
            waterDepthBefore: '',
            waterDepthAfter: ''
          });

          useEffect(() => {
            const timer = setInterval(() => {
              setCurrentTime(new Date());
            }, 1000);
            return () => clearInterval(timer);
          }, []);

          useEffect(() => {
            const handleOnline = () => setIsOnline(true);
            const handleOffline = () => setIsOnline(false);
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            return () => {
              window.removeEventListener('online', handleOnline);
              window.removeEventListener('offline', handleOffline);
            };
          }, []);

          useEffect(() => {
            if (window.AV) {
                try {
                    if (!window.AV.applicationId) {
                        window.AV.init({
                            appId: LEANCLOUD_APP_ID,
                            appKey: LEANCLOUD_APP_KEY,
                            serverURL: LEANCLOUD_SERVER_URL
                        });
                    }
                    setIsSdkReady(true);
                } catch (e) {
                    console.error("LeanCloud init error:", e);
                    setLoadingMessage("连接服务器失败");
                }
            } else {
                setLoadingMessage("等待 SDK 加载...");
            }
          }, []);

          useEffect(() => {
            if (!isSdkReady) return;
            const initData = async () => {
              try {
                setLoadingMessage("正在加载数据...");
                const AV = window.AV;
                
                let serverPoints = [];
                try {
                  const pointQuery = new AV.Query('IrrigationPoint');
                  pointQuery.limit(1000);
                  serverPoints = await pointQuery.find();
                } catch (e) {
                  console.warn("IrrigationPoint class not found, preparing seed data...", e);
                  serverPoints = [];
                }

                let finalPoints = [];
                if (serverPoints.length === 0) {
                  setLoadingMessage("正在初始化基础数据(首次运行)...");
                  try {
                    const newPoints = SEED_POINTS.map(sp => {
                      const p = new AV.Object('IrrigationPoint');
                      p.set('zoneId', sp.zoneId);
                      p.set('name', sp.name);
                      return p;
                    });
                    finalPoints = await AV.Object.saveAll(newPoints);
                  } catch (seedError) {
                    console.error("Failed to seed points:", seedError);
                  }
                } else {
                  finalPoints = serverPoints;
                }

                const mappedPoints = finalPoints.map(p => ({
                  id: p.id,
                  zoneId: p.get('zoneId'),
                  name: p.get('name')
                }));

                setZones(prevZones => prevZones.map(z => ({
                  ...z,
                  points: mappedPoints.filter(mp => mp.zoneId === z.id)
                })));

                let serverRecords = [];
                try {
                  const recordQuery = new AV.Query('IrrigationRecord');
                  recordQuery.limit(1000);
                  recordQuery.descending('createdAt');
                  serverRecords = await recordQuery.find();
                } catch (e) {
                   console.warn("IrrigationRecord class not found (likely no records yet).", e);
                   serverRecords = [];
                }

                const mappedRecords = serverRecords.map(r => ({
                  id: r.id,
                  zoneId: r.get('zoneId'),
                  pointId: r.get('pointId'),
                  pointName: r.get('pointName'),
                  fieldNumber: r.get('fieldNumber'),
                  date: r.get('date'),
                  moistureBefore: r.get('moistureBefore'),
                  moistureAfter: r.get('moistureAfter'),
                  depth: r.get('depth'),
                  waterDepthBefore: r.get('waterDepthBefore'),
                  waterDepthAfter: r.get('waterDepthAfter'),
                  volume: r.get('volume')
                }));

                setRecords(mappedRecords);
                setIsLoading(false);

              } catch (error) {
                console.error("Data Init Critical Error:", error);
                setLoadingMessage("数据初始化异常，请刷新重试: " + error.message);
              }
            };

            initData();
          }, [isSdkReady]);

          const totalPointsCount = useMemo(() => {
            return zones.reduce((total, zone) => total + zone.points.length, 0);
          }, [zones]);

          const sortedRecords = useMemo(() => {
            if (!filterZoneId) return [];
            const filtered = records.filter(r => r.zoneId === filterZoneId);
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
          }, [records, filterZoneId]);

          const handleZoneClick = (zone) => {
            setFilterZoneId(zone.id); 
            setExpandedZoneId(expandedZoneId === zone.id ? null : zone.id);
            setSelectedRecordIds([]);
          };

          const handlePointClick = (e, zone, point) => {
            e.stopPropagation();
            if (editingPointId === point.id) return;
            setSelectedZone(zone);
            setSelectedPoint(point);
            setEditingRecordId(null); 
            setFormData({
              date: new Date().toISOString().split('T')[0],
              fieldNumber: '1',
              moistureBefore: '',
              moistureAfter: '',
              depth: '',
              waterDepthBefore: '',
              waterDepthAfter: ''
            });
            setIsModalOpen(true);
          };

          const startEditPoint = (e, point) => {
            e.stopPropagation();
            setEditingPointId(point.id);
            setEditNameValue(point.name);
          };

          const saveEditPoint = async (e, zoneId, pointId) => {
            e.stopPropagation();
            try {
              const AV = window.AV;
              const point = AV.Object.createWithoutData('IrrigationPoint', pointId);
              point.set('name', editNameValue);
              await point.save();

              setZones(prevZones => prevZones.map(z => {
                if (z.id === zoneId) {
                  return {
                    ...z,
                    points: z.points.map(p => p.id === pointId ? { ...p, name: editNameValue } : p)
                  };
                }
                return z;
              }));
              setEditingPointId(null);
            } catch (error) {
              alert("保存失败: " + error.message);
            }
          };

          const cancelEditPoint = (e) => {
            e.stopPropagation();
            setEditingPointId(null);
          };
          
          const handleDeletePoint = (e, zoneId, pointId) => {
            e.stopPropagation();
            setDeleteType('point');
            setItemToDelete({ zoneId, pointId });
            setDeleteModalOpen(true);
          };

          const handleDeleteRecord = (e, recordId) => {
            if (e) e.stopPropagation();
            setDeleteType('record');
            setItemToDelete({ recordId });
            setDeleteModalOpen(true);
          };

          const handleBatchDelete = () => {
            setDeleteType('batch_records');
            setDeleteModalOpen(true);
          };

          const executeDelete = async () => {
            const AV = window.AV;
            try {
              if (deleteType === 'point' && itemToDelete) {
                const point = AV.Object.createWithoutData('IrrigationPoint', itemToDelete.pointId);
                await point.destroy();
                setZones(prevZones => prevZones.map(z => {
                  if (z.id === itemToDelete.zoneId) {
                    return {
                      ...z,
                      points: z.points.filter(p => p.id !== itemToDelete.pointId)
                    };
                  }
                  return z;
                }));
              } 
              else if (deleteType === 'record' && itemToDelete) {
                const record = AV.Object.createWithoutData('IrrigationRecord', itemToDelete.recordId);
                await record.destroy();
                setRecords(prev => prev.filter(r => r.id !== itemToDelete.recordId));
                setIsModalOpen(false);
              }
              else if (deleteType === 'batch_records') {
                const toDelete = [...selectedRecordIds];
                const objectsToDelete = toDelete.map(id => AV.Object.createWithoutData('IrrigationRecord', id));
                await AV.Object.destroyAll(objectsToDelete);
                setRecords(prev => prev.filter(r => !selectedRecordIds.includes(r.id)));
                setSelectedRecordIds([]);
              }
              setDeleteModalOpen(false);
              setItemToDelete(null);
              setDeleteType(null);
            } catch (error) {
              alert("删除操作失败: " + error.message);
            }
          };

          const handleAddPoint = async (e, zoneId) => {
            e.stopPropagation();
            const newName = "新增样点灌区";
            try {
              const AV = window.AV;
              const Point = new AV.Object('IrrigationPoint');
              Point.set('zoneId', zoneId);
              Point.set('name', newName);
              const savedPoint = await Point.save();

              const newPointData = {
                id: savedPoint.id,
                zoneId: zoneId,
                name: newName
              };

              setZones(prevZones => prevZones.map(z => {
                if (z.id === zoneId) {
                  return {
                    ...z,
                    points: [...z.points, newPointData]
                  };
                }
                return z;
              }));
              setEditingPointId(savedPoint.id);
              setEditNameValue(newName);
            } catch (error) {
              alert("新增失败: " + error.message);
            }
          };

          const handleEditInputClick = (e) => {
            e.stopPropagation();
          };

          const handleEditRecord = (record) => {
            const zone = zones.find(z => z.id === record.zoneId);
            const point = zone?.points.find(p => p.id === record.pointId) || { id: record.pointId, name: record.pointName };
            
            if (zone) {
              setSelectedZone(zone);
              setSelectedPoint(point);
              setEditingRecordId(record.id);
              
              setFormData({
                date: record.date,
                fieldNumber: record.fieldNumber || '1',
                moistureBefore: record.moistureBefore,
                moistureAfter: record.moistureAfter,
                depth: record.depth,
                waterDepthBefore: record.waterDepthBefore,
                waterDepthAfter: record.waterDepthAfter
              });
              setIsModalOpen(true);
            }
          };

          const handleInputChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => {
              const newData = { ...prev, [name]: value };
              if (name === 'waterDepthBefore') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue) && numValue >= 0) {
                   newData.moistureBefore = 0;
                   newData.moistureAfter = 0;
                   newData.depth = 0;
                }
              }
              return newData;
            });
          };

          const handleSelectAll = () => {
            if (selectedRecordIds.length === sortedRecords.length && sortedRecords.length > 0) {
              setSelectedRecordIds([]);
            } else {
              setSelectedRecordIds(sortedRecords.map(r => r.id));
            }
          };

          const handleSelectRecord = (id) => {
            setSelectedRecordIds(prev => {
              if (prev.includes(id)) {
                return prev.filter(pid => pid !== id);
              } else {
                return [...prev, id];
              }
            });
          };

          const calculatedVolume = useMemo(() => {
            const after = parseFloat(formData.moistureAfter);
            const before = parseFloat(formData.moistureBefore);
            const depth = parseFloat(formData.depth);
            const wAfter = formData.waterDepthAfter ? parseFloat(formData.waterDepthAfter) : 0;
            const wBefore = formData.waterDepthBefore ? parseFloat(formData.waterDepthBefore) : 0;
            
            const isSoilParamsValid = !isNaN(after) && !isNaN(before) && !isNaN(depth);
            
            if (isSoilParamsValid) {
              const soilPart = ((after - before) * depth) / 15;
              const waterPart = (wAfter - wBefore) / 1.5;
              const vol = soilPart + waterPart;
              return vol > 0 ? vol.toFixed(2) : "0.00";
            }
            return "---";
          }, [formData]);

          const currentFilterZoneName = useMemo(() => {
            if (!filterZoneId) return null;
            return zones.find(z => z.id === filterZoneId)?.name;
          }, [filterZoneId, zones]);

          const handleAIAnalysis = () => {
            if (sortedRecords.length === 0) {
              alert("当前区域暂无数据，无法进行分析");
              return;
            }
            const totalVol = sortedRecords.reduce((sum, r) => sum + r.volume, 0);
            const avgVol = (totalVol / sortedRecords.length).toFixed(2);
            const validMoistureRecords = sortedRecords.filter(r => r.moistureBefore && r.moistureAfter);
            let avgMoistureDiff = 0;
            if (validMoistureRecords.length > 0) {
              const totalDiff = validMoistureRecords.reduce((sum, r) => sum + (r.moistureAfter - r.moistureBefore), 0);
              avgMoistureDiff = (totalDiff / validMoistureRecords.length).toFixed(2);
            }
            let suggestion = "";
            if (parseFloat(avgVol) > 50) {
              suggestion = "平均灌水量偏高，建议适当减少单次灌溉时长或频率，注意节水。";
            } else if (parseFloat(avgVol) < 10) {
               suggestion = "平均灌水量较低，请关注作物是否缺水，或检查数据录入是否准确。";
            } else {
              suggestion = "当前灌溉水量处于合理区间，请继续保持科学灌溉。";
            }
            setAiAnalysisResult({
              count: sortedRecords.length,
              avgVol,
              avgMoistureDiff,
              suggestion
            });
            setAiModalOpen(true);
          };

          const handleGeminiGlobalAnalysis = async () => {
            setIsGeminiAnalyzing(true);
            setGeminiGlobalModalOpen(true);
            const zoneSummary = zones.map(zone => {
              const zoneRecs = records.filter(r => r.zoneId === zone.id);
              const totalVol = zoneRecs.reduce((sum, r) => sum + r.volume, 0);
              const avgVol = zoneRecs.length > 0 ? (totalVol / zoneRecs.length).toFixed(2) : 0;
              return {
                name: zone.name,
                recordCount: zoneRecs.length,
                avgVolume: avgVol
              };
            });
            const promptText = `
              你是一位资深水利农业专家。请根据以下上海市各区灌溉数据进行综合分析：
              数据JSON: ${JSON.stringify(zoneSummary)}
              请生成一份简短的中文分析报告，包含：
              1. 全市灌溉活跃度分析（基于填报数量）。
              2. 区域用水量对比（指出哪个区平均灌水量最大/最小）。
              3. 针对性的节水建议（不超过3条）。
              格式要求：使用Markdown格式，语气专业且亲切。
            `;
            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }],
                  }),
                }
              );
              if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
              }
              const data = await response.json();
              const analysisText = data.candidates?.[0]?.content?.parts?.[0]?.text || "分析服务暂不可用。";
              setGeminiGlobalResult(analysisText);
            } catch (error) {
              console.error("Gemini Error:", error);
              setGeminiGlobalResult(`**系统提示：** AI分析服务连接超时或未配置。\n\n基于本地数据简报：\n- 当前共有 ${records.length} 条填报记录。\n- 数据覆盖了 ${zones.length} 个行政区。\n- 请检查各区填报进度是否均衡。`);
            } finally {
              setIsGeminiAnalyzing(false);
            }
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (parseFloat(formData.waterDepthBefore) < 0) return;
            if (calculatedVolume === "---" || parseFloat(calculatedVolume) <= 0) return;
            const localData = {
              zoneId: selectedZone.id,
              pointId: selectedPoint.id,     
              pointName: selectedPoint.name, 
              date: formData.date,
              fieldNumber: parseInt(formData.fieldNumber),
              moistureBefore: parseFloat(formData.moistureBefore),
              moistureAfter: parseFloat(formData.moistureAfter),
              depth: parseFloat(formData.depth),
              waterDepthBefore: formData.waterDepthBefore ? parseFloat(formData.waterDepthBefore) : 0,
              waterDepthAfter: formData.waterDepthAfter ? parseFloat(formData.waterDepthAfter) : 0,
              volume: parseFloat(calculatedVolume)
            };
            try {
              const AV = window.AV;
              let recordObj;
              if (editingRecordId) {
                recordObj = AV.Object.createWithoutData('IrrigationRecord', editingRecordId);
              } else {
                recordObj = new AV.Object('IrrigationRecord');
              }
              Object.keys(localData).forEach(key => {
                recordObj.set(key, localData[key]);
              });
              const savedRecord = await recordObj.save();
              const finalRecord = { ...localData, id: savedRecord.id };
              if (editingRecordId) {
                setRecords(prev => prev.map(item => item.id === editingRecordId ? finalRecord : item));
              } else {
                setRecords(prev => [finalRecord, ...prev]);
              }
              setFilterZoneId(selectedZone.id); 
              setIsModalOpen(false);
              setEditingRecordId(null);
            } catch (error) {
              alert("数据保存失败: " + error.message);
            }
          };

          if (isLoading) {
            return (
              <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-slate-600">
                <Loader2 size={48} className="animate-spin text-blue-600 mb-4" />
                <h2 className="text-xl font-bold">{loadingMessage}</h2>
                <p className="text-sm mt-2 opacity-70">正在连接 LeanCloud 数据中心...</p>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-slate-100/50 font-sans text-slate-900 flex flex-col">
              
              {/* Header (已应用 z-40 修复遮挡问题) */}
              <header className="bg-gradient-to-r from-blue-800 via-blue-700 to-cyan-600 text-white shadow-xl sticky top-0 z-40 border-b border-white/10">
                <div className="container mx-auto px-6 py-4 flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="bg-white/10 p-2 rounded-xl backdrop-blur-sm shadow-inner">
                       <Sprout size={28} className="text-green-300" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold tracking-wide text-white drop-shadow-sm">上海市灌溉数据填报系统</h1>
                      <p className="text-xs text-blue-100 opacity-80 flex items-center gap-1 font-medium">
                        Shanghai Irrigation Data Reporting System
                      </p>
                    </div>
                  </div>
                  
                  <div className="hidden md:flex items-center gap-8">
                    <div className="flex flex-col items-end">
                       <div className="text-3xl font-mono font-bold leading-none tracking-wider text-white drop-shadow-md">
                         {currentTime.toLocaleTimeString('zh-CN', { hour12: false })}
                       </div>
                       <div className="text-xs font-medium opacity-90 mt-1 tracking-widest uppercase text-blue-50">
                         {currentTime.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' })}
                       </div>
                    </div>
                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full backdrop-blur-md border shadow-inner ${isOnline ? 'bg-green-500/20 border-green-400/30' : 'bg-red-500/20 border-red-400/30'}`}>
                      {isOnline ? (
                        <>
                          <span className="relative flex h-2.5 w-2.5">
                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]"></span>
                          </span>
                          <span className="text-xs font-bold text-green-50">在线</span>
                        </>
                      ) : (
                         <>
                          <span className="inline-flex rounded-full h-2.5 w-2.5 bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></span>
                          <span className="text-xs font-bold text-red-100">离线</span>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </header>

              <main className="flex-grow container mx-auto px-6 py-8 space-y-8">
                
                {/* 区域选择部分 */}
                <section>
                  <div className="flex justify-between items-end mb-5">
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-200">
                        <MapPin className="text-blue-600" size={20} />
                        <h2 className="text-lg font-bold text-slate-800">区域选择与填报</h2>
                      </div>
                      <span className="text-xs font-bold bg-gradient-to-r from-blue-600 to-cyan-500 text-white px-3 py-1.5 rounded-full shadow-md shadow-blue-200">
                        共 {totalPointsCount} 个样点灌区
                      </span>
                    </div>
                    
                    <button 
                      onClick={handleGeminiGlobalAnalysis}
                      className="group flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2.5 rounded-xl shadow-lg hover:shadow-indigo-200 transition-all transform hover:-translate-y-0.5"
                    >
                      <Bot size={18} className="text-purple-200 group-hover:animate-bounce" />
                      <span className="font-bold text-sm">综合分析</span>
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 items-start">
                    {zones.map(zone => {
                      const isExpanded = expandedZoneId === zone.id;
                      const isSelected = filterZoneId === zone.id;
                      
                      return (
                        <div 
                          key={zone.id} 
                          className={`group relative rounded-2xl transition-all duration-300 overflow-hidden ${
                            isSelected 
                              ? 'bg-white ring-2 ring-blue-400 shadow-lg shadow-blue-100 scale-[1.01]' 
                              : 'bg-white border border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-200 hover:-translate-y-1'
                          }`}
                        >
                          <div 
                            onClick={() => handleZoneClick(zone)}
                            className="p-6 cursor-pointer relative z-10 bg-white"
                          >
                            {isSelected && (
                              <div className="absolute top-0 right-0 bg-blue-500 text-white px-3 py-1 text-[10px] font-bold rounded-bl-xl shadow-sm">
                                当前查看
                              </div>
                            )}
                            <div className="flex justify-between items-start mb-3">
                              <h3 className={`text-lg font-bold tracking-tight ${isSelected ? 'text-blue-700' : 'text-slate-700 group-hover:text-blue-600'}`}>
                                {zone.name}
                              </h3>
                              <div className={`transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                                {isExpanded ? <ChevronUp className="text-blue-500" size={20}/> : <ChevronDown className="text-slate-300 group-hover:text-blue-400" size={20}/>}
                              </div>
                            </div>
                            <div className={`text-xs font-medium inline-block px-2.5 py-1 rounded-md transition-colors ${isSelected ? 'bg-blue-50 text-blue-600' : 'bg-slate-50 text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-500'}`}>
                              下辖 {zone.points.length} 个灌区
                            </div>
                          </div>

                          <div 
                            className={`bg-slate-50 border-t border-slate-100 transition-all duration-500 ease-in-out overflow-hidden ${
                              isExpanded ? 'max-h-80 opacity-100 overflow-y-auto' : 'max-h-0 opacity-0'
                            }`}
                          >
                            <div className="p-3 space-y-2">
                              <p className="text-[10px] font-bold text-slate-400 px-2 uppercase tracking-wider">选择填报对象:</p>
                              {zone.points.length > 0 ? zone.points.map(point => {
                                const isEditing = editingPointId === point.id;
                                
                                return (
                                  <div
                                    key={point.id}
                                    onClick={(e) => !isEditing && handlePointClick(e, zone, point)}
                                    className={`relative w-full text-left px-3 py-2.5 rounded-xl text-sm font-medium transition-all flex items-center gap-2 group/item ${
                                      isEditing ? 'bg-white ring-2 ring-blue-300 shadow-sm' : 'text-slate-600 hover:bg-white hover:shadow-md hover:text-blue-600 cursor-pointer border border-transparent hover:border-slate-100'
                                    }`}
                                  >
                                    {isEditing ? (
                                      <div className="flex items-center w-full gap-2">
                                        <input 
                                          type="text" 
                                          value={editNameValue}
                                          onChange={(e) => setEditNameValue(e.target.value)}
                                          onClick={handleEditInputClick}
                                          autoFocus
                                          className="flex-grow bg-transparent outline-none text-slate-800 font-bold border-b-2 border-blue-400 px-1"
                                        />
                                        <button 
                                          onClick={(e) => saveEditPoint(e, zone.id, point.id)}
                                          className="p-1.5 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
                                        >
                                          <Check size={14} />
                                        </button>
                                        <button 
                                          onClick={cancelEditPoint}
                                          className="p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                                        >
                                          <X size={14} />
                                        </button>
                                      </div>
                                    ) : (
                                      <>
                                        <div className="w-1.5 h-1.5 rounded-full bg-slate-300 group-hover/item:bg-blue-400 transition-colors"></div>
                                        <span className="flex-grow truncate">{point.name}</span>
                                        <div className="flex items-center opacity-0 group-hover/item:opacity-100 transition-all transform translate-x-2 group-hover/item:translate-x-0">
                                          <button 
                                            onClick={(e) => startEditPoint(e, point)}
                                            className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-100 rounded-lg mr-1"
                                          >
                                            <Pencil size={12} />
                                          </button>
                                          <button 
                                            onClick={(e) => handleDeletePoint(e, zone.id, point.id)}
                                            className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-100 rounded-lg"
                                          >
                                            <Trash2 size={12} />
                                          </button>
                                        </div>
                                      </>
                                    )}
                                  </div>
                                );
                              }) : (
                                <div className="text-xs text-slate-400 text-center py-4 bg-slate-100 rounded-lg border border-dashed border-slate-200">暂无数据</div>
                              )}
                              
                              <button
                                onClick={(e) => handleAddPoint(e, zone.id)}
                                className="w-full text-left px-3 py-2.5 rounded-xl text-xs font-bold text-blue-600 hover:bg-blue-50 border border-dashed border-blue-300 hover:border-blue-400 transition-all flex items-center justify-center gap-2 mt-2"
                              >
                                <Plus size={14} /> 新增样点灌区
                              </button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </section>
                
                {/* 历史数据表格部分 (已修复滚动透视和层级问题) */}
                <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden h-[650px] flex flex-col relative z-0">
                  <div className="px-6 py-4 border-b-2 border-indigo-100 bg-slate-50 flex justify-between items-center h-16 relative z-20 flex-shrink-0">
                    <div className="flex items-center gap-3">
                      <div className="bg-white p-1.5 rounded-lg shadow-sm border border-slate-200 text-blue-600">
                        <History size={18} />
                      </div>
                      <h2 className="font-bold text-slate-700 flex items-center gap-2">
                        {currentFilterZoneName ? (
                          <>
                            <span className="text-slate-400">当前区域:</span> 
                            <div className="relative group">
                              <span className="text-blue-700 bg-blue-50 px-3 py-1 rounded border border-blue-100 font-bold">{currentFilterZoneName}</span>
                              <div className="absolute -bottom-2 left-0 w-full h-0.5 bg-blue-400 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </div>
                          </>
                        ) : '填报记录 (请先选择区域)'}
                      </h2>
                    </div>
                    
                    <div className="flex items-center gap-3">
                       <button 
                         onClick={handleAIAnalysis}
                         className="group bg-white hover:bg-slate-50 text-slate-600 hover:text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-200 flex items-center gap-1.5 transition-all"
                       >
                         <BarChart3 size={14} className="text-slate-400 group-hover:text-blue-500" /> 
                         本区分析
                       </button>

                       {selectedRecordIds.length > 0 && (
                         <button 
                           onClick={handleBatchDelete}
                           className="animate-in fade-in slide-in-from-right-5 bg-red-50 text-red-600 px-4 py-2 rounded-xl text-xs font-bold border border-red-200 hover:bg-red-100 hover:border-red-300 flex items-center gap-2 transition-all shadow-sm"
                         >
                           <Trash2 size={14} /> 批量删除 ({selectedRecordIds.length})
                         </button>
                       )}

                       <span className="text-xs font-medium text-slate-500 bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
                         共 {sortedRecords.length} 条记录
                       </span>
                    </div>
                    
                    <div className="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-indigo-200 to-transparent"></div>
                  </div>
                  
                  <div className="overflow-auto flex-grow">
                    <table className="w-full text-sm text-left border-collapse">
                      <thead className="text-xs text-slate-500 font-semibold uppercase bg-white border-b border-slate-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                          <th className="px-4 py-4 w-12 text-center">
                            {sortedRecords.length > 0 && (
                              <button onClick={handleSelectAll} className="text-slate-400 hover:text-blue-600 transition-colors">
                                {selectedRecordIds.length === sortedRecords.length && sortedRecords.length > 0 ? 
                                  <CheckSquare size={18} className="text-blue-600 drop-shadow-sm"/> : 
                                  <Square size={18} />
                                }
                              </button>
                            )}
                          </th>
                          <th className="px-4 py-4">填报日期</th>
                          <th className="px-4 py-4">行政区</th>
                          <th className="px-4 py-4 text-blue-700">样点灌区名称</th>
                          <th className="px-4 py-4 text-center">典型田块</th>
                          <th className="px-4 py-4 text-right">灌水前水深</th>
                          <th className="px-4 py-4 text-right">灌水后水深</th>
                          <th className="px-4 py-4 text-right">灌前含水率</th>
                          <th className="px-4 py-4 text-right">灌后含水率</th>
                          <th className="px-4 py-4 text-right">湿润层深度</th>
                          <th className="px-4 py-4 text-right text-blue-700 bg-blue-50/30">本次灌水量</th>
                          <th className="px-4 py-4 text-center w-20">操作</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100 bg-white">
                        {sortedRecords.length > 0 ? (
                          sortedRecords.map((record, index) => {
                            const zoneName = zones.find(z => z.id === record.zoneId)?.name;
                            const isSelected = selectedRecordIds.includes(record.id);
                            
                            return (
                              <tr 
                                key={record.id} 
                                onDoubleClick={() => handleEditRecord(record)}
                                className={`
                                  transition-all duration-200 cursor-pointer select-none group
                                  ${isSelected ? 'bg-blue-50/80' : index % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'}
                                  hover:bg-blue-50 hover:shadow-sm relative
                                `}
                              >
                                <td className="px-4 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                                  <button onClick={() => handleSelectRecord(record.id)} className="text-slate-400 hover:text-blue-600 transition-colors">
                                    {isSelected ? <CheckSquare size={18} className="text-blue-600"/> : <Square size={18} />}
                                  </button>
                                </td>
                                <td className="px-4 py-4 font-mono text-slate-600 text-xs font-medium tracking-wide">
                                  {record.date}
                                </td>
                                <td className="px-4 py-4 font-medium text-slate-600">{zoneName}</td>
                                <td className="px-4 py-4 font-bold text-slate-700 group-hover:text-blue-700 transition-colors">{record.pointName || '---'}</td>
                                <td className="px-4 py-4 text-center font-mono font-bold text-slate-500 bg-slate-100/50 rounded m-1 inline-block w-8">{record.fieldNumber}</td>
                                <td className="px-4 py-4 text-right text-slate-500 font-mono">{record.waterDepthBefore} <span className="text-[10px] text-slate-300">mm</span></td>
                                <td className="px-4 py-4 text-right text-slate-500 font-mono">{record.waterDepthAfter} <span className="text-[10px] text-slate-300">mm</span></td>
                                <td className="px-4 py-4 text-right text-slate-600 font-mono">{record.moistureBefore}<span className="text-[10px] text-slate-300">%</span></td>
                                <td className="px-4 py-4 text-right text-slate-600 font-mono">{record.moistureAfter}<span className="text-[10px] text-slate-300">%</span></td>
                                <td className="px-4 py-4 text-right text-slate-600 font-mono">{record.depth} <span className="text-[10px] text-slate-300">cm</span></td>
                                <td className="px-4 py-4 text-right font-bold text-blue-600 bg-blue-50/30 font-mono border-l border-slate-100 group-hover:border-white">
                                  {record.volume.toFixed(2)} <span className="text-[10px] font-normal text-slate-400">方/亩</span>
                                </td>
                                <td className="px-4 py-4 text-center">
                                  <button 
                                    onClick={(e) => handleDeleteRecord(e, record.id)}
                                    className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100"
                                    title="删除此条记录"
                                  >
                                    <Trash2 size={16} />
                                  </button>
                                </td>
                              </tr>
                            );
                          })
                        ) : (
                          <tr>
                            <td colSpan="12" className="px-6 py-24 text-center">
                              {filterZoneId ? (
                                <div className="flex flex-col items-center gap-4 text-slate-400 animate-in fade-in slide-in-from-bottom-4">
                                  <div className="bg-slate-50 p-4 rounded-full">
                                    <ClipboardEdit size={48} className="text-slate-300" />
                                  </div>
                                  <div>
                                    <p className="text-lg font-medium text-slate-500">该区域暂无填报数据</p>
                                    <p className="text-sm mt-1">请点击对应区域的展开菜单进行数据录入</p>
                                  </div>
                                </div>
                              ) : (
                                <div className="flex flex-col items-center gap-4 text-slate-400 animate-in fade-in slide-in-from-bottom-4">
                                  <div className="bg-blue-50 p-4 rounded-full animate-bounce">
                                    <LayoutDashboard size={48} className="text-blue-300" />
                                  </div>
                                  <div>
                                    <p className="text-lg font-bold text-slate-600">请选择一个行政区</p>
                                    <p className="text-sm mt-1">点击上方卡片开始管理与填报数据</p>
                                  </div>
                                </div>
                              )}
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </section>
              </main>

              {/* 填报对话框 (Modal) */}
              {isModalOpen && selectedZone && selectedPoint && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm transition-all animate-in fade-in duration-200">
                  <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-100 transform scale-100">
                    
                    <div className="px-8 py-6 bg-gradient-to-r from-blue-600 to-blue-500 text-white flex justify-between items-center">
                      <div>
                        <h3 className="font-bold text-xl flex items-center gap-2">
                          <ClipboardEdit size={24} className="text-blue-200" /> 
                          {editingRecordId ? '修改填报数据' : '新增填报数据'}
                        </h3>
                        <div className="flex items-center gap-2 mt-2 text-xs text-blue-100/80">
                          <span className="bg-white/20 px-2 py-0.5 rounded">{selectedZone.name}</span>
                          <span>/</span>
                          <span className="font-bold text-white">{selectedPoint.name}</span>
                        </div>
                      </div>
                      <button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-white/20 rounded-full transition-colors">
                        <X size={24} />
                      </button>
                    </div>

                    <form onSubmit={handleSubmit} className="p-8 space-y-6 bg-slate-50/50">
                      
                      <div className="flex gap-6">
                        <div className="space-y-2 flex-grow">
                          <label className="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wider">
                            灌水日期
                          </label>
                          <div className="relative group">
                            <Calendar size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors" />
                            <input 
                              type="date" 
                              name="date"
                              required
                              value={formData.date}
                              onChange={handleInputChange}
                              className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-400 outline-none transition-all shadow-sm font-medium text-slate-700"
                            />
                          </div>
                        </div>
                        
                        <div className="space-y-2 w-1/3">
                          <label className="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wider">
                            典型田块
                          </label>
                          <div className="relative">
                            <select
                              name="fieldNumber"
                              value={formData.fieldNumber}
                              onChange={handleInputChange}
                              className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-400 outline-none shadow-sm font-bold text-slate-700 appearance-none"
                            >
                              <option value="1">1号田</option>
                              <option value="2">2号田</option>
                              <option value="3">3号田</option>
                            </select>
                            <ChevronDown size={16} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
                          </div>
                        </div>
                      </div>

                      <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-5">
                        <h4 className="text-xs font-bold text-blue-600 uppercase tracking-wider flex items-center gap-2 border-b border-slate-100 pb-2">
                          <Ruler size={14} /> 田面水层深度 (mm)
                        </h4>
                        <div className="grid grid-cols-2 gap-6">
                          <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-600">灌水前</label>
                            <input 
                              type="number" 
                              name="waterDepthBefore"
                              step="1"
                              placeholder="0"
                              value={formData.waterDepthBefore}
                              onChange={handleInputChange}
                              className={`w-full px-4 py-2.5 rounded-xl border bg-slate-50 focus:bg-white outline-none transition-all ${
                                formData.waterDepthBefore && parseFloat(formData.waterDepthBefore) < 0 
                                  ? "border-red-300 focus:ring-4 focus:ring-red-100" 
                                  : "border-slate-200 focus:border-blue-400 focus:ring-4 focus:ring-blue-50"
                              }`}
                            />
                          </div>
                          
                          <div className="space-y-2">
                            <label className="text-sm font-medium text-slate-600">灌水后</label>
                            <input 
                              type="number" 
                              name="waterDepthAfter"
                              step="1"
                              placeholder="0"
                              value={formData.waterDepthAfter}
                              onChange={handleInputChange}
                              className="w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-400 focus:ring-4 focus:ring-blue-50 outline-none transition-all"
                            />
                          </div>
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-6">
                        <div className="space-y-2">
                          <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">
                            灌前含水率 (%)
                          </label>
                          <input 
                            type="number" 
                            name="moistureBefore"
                            step="0.1"
                            placeholder="0.0"
                            required
                            value={formData.moistureBefore}
                            onChange={handleInputChange}
                            className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-400 outline-none transition-all shadow-sm"
                          />
                        </div>
                        <div className="space-y-2">
                          <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">
                            灌后含水率 (%)
                          </label>
                          <input 
                            type="number" 
                            name="moistureAfter"
                            step="0.1"
                            placeholder="0.0"
                            required
                            value={formData.moistureAfter}
                            onChange={handleInputChange}
                            className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-4 focus:ring-blue-100 focus:border-blue-400 outline-none transition-all shadow-sm"
                          />
                        </div>
                      </div>

                      <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">
                          计划湿润层深度 (cm)
                        </label>
                        <div className="relative">
                           <Layers size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-amber-400" />
                           <input 
                            type="number" 
                            name="depth"
                            placeholder="例如: 40"
                            required
                            value={formData.depth}
                            onChange={handleInputChange}
                            className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 bg-white focus:ring-4 focus:ring-amber-100 focus:border-amber-400 outline-none transition-all shadow-sm"
                          />
                        </div>
                      </div>

                      <div className="bg-blue-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-200 relative overflow-hidden group">
                        <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                           <Calculator size={80} />
                        </div>
                        <div className="relative z-10">
                          <div className="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">自动计算灌水量</div>
                          <div className="flex items-end gap-2">
                            <span className="text-4xl font-bold tracking-tight">{calculatedVolume}</span>
                            <span className="text-sm font-medium opacity-80 mb-1.5">方/亩</span>
                          </div>
                        </div>
                      </div>

                      <div className="flex gap-4 pt-2">
                        {editingRecordId && (
                          <button 
                            type="button" 
                            onClick={(e) => handleDeleteRecord(e, editingRecordId)}
                            className="px-4 py-3 rounded-xl border border-red-200 text-red-500 hover:bg-red-50 font-bold transition-colors flex items-center gap-2"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button 
                          type="button" 
                          onClick={() => setIsModalOpen(false)}
                          className="flex-1 px-6 py-3 rounded-xl border border-slate-200 text-slate-600 hover:bg-slate-100 font-bold transition-colors"
                        >
                          取消
                        </button>
                        <button 
                          type="submit"
                          className="flex-[2] px-6 py-3 rounded-xl bg-blue-600 text-white hover:bg-blue-700 font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex justify-center items-center gap-2"
                        >
                          <Save size={20} /> {editingRecordId ? '更新数据' : '确认保存'}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* 通用删除确认 Modal */}
              {deleteModalOpen && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-md animate-in fade-in">
                  <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-8 border border-slate-100 transform transition-all scale-100">
                    <div className="flex flex-col items-center text-center">
                      <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6 shadow-inner">
                        <Trash2 size={32} />
                      </div>
                      <h3 className="text-xl font-bold text-slate-800 mb-3">确认删除?</h3>
                      <p className="text-slate-500 text-sm mb-8 leading-relaxed">
                        {deleteType === 'batch_records' 
                          ? `您即将删除 ${selectedRecordIds.length} 条记录，此操作无法撤销。`
                          : '您确定要删除该数据吗？此操作将永久移除该条记录且无法撤销。'}
                      </p>
                      <div className="flex w-full gap-4">
                        <button
                          onClick={() => setDeleteModalOpen(false)}
                          className="flex-1 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 font-bold transition-colors"
                        >
                          取消
                        </button>
                        <button
                          onClick={executeDelete}
                          className="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 font-bold shadow-lg shadow-red-200 transition-all"
                        >
                          确认删除
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* 局部分析结果 Modal */}
              {aiModalOpen && aiAnalysisResult && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-indigo-900/60 backdrop-blur-md animate-in fade-in">
                  <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden border border-white/20">
                     <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center shadow-lg relative overflow-hidden">
                       <div className="absolute top-0 left-0 w-full h-full bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                       <h3 className="font-bold text-xl flex items-center gap-2 relative z-10">
                         <BarChart3 size={24} className="text-white/80" /> 本区数据分析
                       </h3>
                       <button onClick={() => setAiModalOpen(false)} className="p-2 hover:bg-white/20 rounded-full transition-colors relative z-10">
                         <X size={20} />
                       </button>
                     </div>
                     
                     <div className="p-8 space-y-8">
                        <div className="grid grid-cols-2 gap-6">
                          <div className="bg-slate-50 p-4 rounded-2xl text-center border border-slate-100 shadow-sm">
                            <div className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">分析样本数</div>
                            <div className="text-3xl font-bold text-slate-700">{aiAnalysisResult.count} <span className="text-xs font-normal text-slate-400">条</span></div>
                          </div>
                          <div className="bg-blue-50 p-4 rounded-2xl text-center border border-blue-100 shadow-sm">
                            <div className="text-xs font-bold text-blue-400 uppercase mb-2 tracking-wider">平均灌水量</div>
                            <div className="text-3xl font-bold text-blue-600">{aiAnalysisResult.avgVol} <span className="text-xs font-normal text-blue-400">方/亩</span></div>
                          </div>
                        </div>
                        
                        <div className="space-y-3">
                          <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <div className="p-1.5 bg-blue-100 rounded-lg text-blue-600"><Droplets size={16} /></div>
                            土壤墒情变化
                          </h4>
                          <div className="bg-slate-50 p-4 rounded-2xl text-sm text-slate-600 border border-slate-200 leading-relaxed">
                            灌溉前后含水率平均提升 <span className="font-bold text-green-600 bg-green-50 px-1 rounded">+{aiAnalysisResult.avgMoistureDiff}%</span>。
                          </div>
                        </div>

                        <div className="space-y-3">
                          <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <div className="p-1.5 bg-indigo-100 rounded-lg text-indigo-600"><BrainCircuit size={16} /></div>
                            智能建议
                          </h4>
                          <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-2xl text-sm text-indigo-900 border border-indigo-100 leading-relaxed shadow-inner">
                            {aiAnalysisResult.suggestion}
                          </div>
                        </div>

                        <button 
                          onClick={() => setAiModalOpen(false)}
                          className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all hover:-translate-y-1"
                        >
                          知晓
                        </button>
                     </div>
                  </div>
                </div>
              )}

              {/* Gemini 全局分析 Modal */}
              {geminiGlobalModalOpen && (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-lg animate-in fade-in">
                  <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-white/20 flex flex-col max-h-[85vh]">
                     <div className="bg-gradient-to-r from-purple-700 via-indigo-700 to-blue-700 p-6 text-white flex justify-between items-center shadow-lg flex-shrink-0">
                       <h3 className="font-bold text-xl flex items-center gap-3">
                         <Bot size={28} className="text-purple-200" /> 
                         Ai 综合决策分析
                       </h3>
                       <button onClick={() => setGeminiGlobalModalOpen(false)} className="p-2 hover:bg-white/20 rounded-full transition-colors">
                         <X size={20} />
                       </button>
                     </div>
                     
                     <div className="p-8 overflow-y-auto custom-scrollbar">
                       {isGeminiAnalyzing ? (
                         <div className="flex flex-col items-center justify-center py-12 space-y-6">
                           <div className="relative">
                             <div className="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                             <div className="absolute top-0 left-0 w-16 h-16 flex items-center justify-center">
                               <Sparkles size={20} className="text-indigo-600 animate-pulse" />
                             </div>
                           </div>
                           <div className="text-center space-y-2">
                             <h4 className="text-lg font-bold text-slate-700">Gemini 正在思考中...</h4>
                             <p className="text-slate-500 text-sm">正在分析全市 {zones.length} 个区域的历史灌溉数据</p>
                           </div>
                         </div>
                       ) : (
                         <div className="space-y-6 animate-in slide-in-from-bottom-4">
                           <div className="prose prose-indigo max-w-none">
                             <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 leading-relaxed text-slate-700 whitespace-pre-wrap">
                               {geminiGlobalResult}
                             </div>
                           </div>
                           
                           <div className="flex justify-end pt-4">
                             <button 
                               onClick={() => setGeminiGlobalModalOpen(false)}
                               className="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition-all hover:-translate-y-1"
                             >
                               关闭报告
                             </button>
                           </div>
                         </div>
                       )}
                     </div>
                  </div>
                </div>
              )}

              <footer className="bg-white border-t border-slate-200 py-8 mt-auto">
                <div className="container mx-auto px-4 text-center">
                  <p className="text-sm font-medium text-slate-500">
                    &copy; 2025 上海市智慧水利数据中心 | 数据填报子系统 V1.0
                  </p>
                </div>
              </footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
